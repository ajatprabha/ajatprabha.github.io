<!DOCTYPE html>
<html>
<head>

    <!-- Document Settings -->
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />

    <!-- Base Meta -->
    <!-- dynamically fixing the title for tag/author pages -->



    <title>Introduction to xrun: A Flexible Package for Managing Component Lifecycles in Go</title>
    <meta name="HandheldFriendly" content="True" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <!-- Styles'n'Scripts -->
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/screen.edited.css" />
    <link rel="stylesheet" type="text/css" href="/assets/built/syntax.css" />
    <!-- highlight.js -->
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css">
    <style>.hljs { background: none; }</style>

    <!-- This tag outputs SEO meta+structured data and other important settings -->
    <meta name="description" content="Blog" />
    <link rel="shortcut icon" href="https://ajatprabha.in/assets/images/favicon.png" type="image/png" />
    <link rel="canonical" href="https://ajatprabha.in/2023/05/24/intro-xrun-package-managing-component-lifecycle-go" />
    <meta name="referrer" content="no-referrer-when-downgrade" />

     <!--title below is coming from _includes/dynamic_title-->
    <meta property="og:site_name" content="Ajat Prabha" />
    <meta property="og:type" content="website" />
    <meta property="og:title" content="Introduction to xrun: A Flexible Package for Managing Component Lifecycles in Go" />
    <meta property="og:description" content="Hello, Go community! Today, I am excited to announce a Golang package I have been working on named xrun. This package provides a streamlined way of running multiple components, specifically long-running components like an HTTP server or background worker. In this blog post, I will walk you through the basic" />
    <meta property="og:url" content="https://ajatprabha.in/2023/05/24/intro-xrun-package-managing-component-lifecycle-go" />
    <meta property="og:image" content="https://ajatprabha.in/assets/images/gophers.jpg" />
    <meta property="article:publisher" content="https://www.facebook.com/iAmAjat" />
    <meta property="article:author" content="https://www.facebook.com/iAmAjat" />
    <meta property="article:published_time" content="2023-05-24T01:00:00+00:00" />
    <meta property="article:modified_time" content="2023-05-24T01:00:00+00:00" />
    <meta property="article:tag" content="Golang" />
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:title" content="Introduction to xrun: A Flexible Package for Managing Component Lifecycles in Go" />
    <meta name="twitter:description" content="Hello, Go community! Today, I am excited to announce a Golang package I have been working on named xrun. This package provides a streamlined way of running multiple components, specifically long-running components like an HTTP server or background worker. In this blog post, I will walk you through the basic" />
    <meta name="twitter:url" content="https://ajatprabha.in/" />
    <meta name="twitter:image" content="https://ajatprabha.in/assets/images/gophers.jpg" />
    <meta name="twitter:label1" content="Written by" />
    <meta name="twitter:data1" content="Ajat Prabha" />
    <meta name="twitter:label2" content="Filed under" />
    <meta name="twitter:data2" content="Golang" />
    <meta name="twitter:site" content="@ajatprabha" />
    <meta name="twitter:creator" content="@ajatprabha" />
    <meta property="og:image:width" content="1400" />
    <meta property="og:image:height" content="933" />

    <script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Website",
    "publisher": {
        "@type": "Organization",
        "name": "Ajat Prabha",
        "logo": "https://ajatprabha.in/assets/images/blog-icon.png"
    },
    "url": "https://ajatprabha.in/2023/05/24/intro-xrun-package-managing-component-lifecycle-go",
    "image": {
        "@type": "ImageObject",
        "url": "https://ajatprabha.in/assets/images/gophers.jpg",
        "width": 2000,
        "height": 666
    },
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "https://ajatprabha.in/2023/05/24/intro-xrun-package-managing-component-lifecycle-go"
    },
    "description": "Hello, Go community! Today, I am excited to announce a Golang package I have been working on named xrun. This package provides a streamlined way of running multiple components, specifically long-running components like an HTTP server or background worker. In this blog post, I will walk you through the basic"
}
    </script>

    <!-- <script type="text/javascript" src="https://demo.ghost.io/public/ghost-sdk.min.js?v=724281a32e"></script>
    <script type="text/javascript">
    ghost.init({
    	clientId: "ghost-frontend",
    	clientSecret: "f84a07a72b17"
    });
    </script> -->

    <meta name="generator" content="Jekyll 3.6.2" />
    <link type="application/atom+xml" rel="alternate" href="https://ajatprabha.in/feed.xml" title="Ajat Prabha" />


</head>
<body class="post-template">

    <div class="site-wrapper">
        <!-- All the main content gets inserted here, index.hbs, post.hbs, etc -->
        <!-- default -->

<!-- The tag above means: insert everything in this file
into the {body} of the default.hbs template -->

<header class="site-header outer">
    <div class="inner">
        <nav class="site-nav">
    <div class="site-nav-left">
        
            
                <a class="site-nav-logo" href="https://ajatprabha.in/"><img src="/assets/images/blog-icon.png" alt="Ajat Prabha" /></a>
            
        
        
            <ul class="nav" role="menu">
    <li class="nav-home" role="menuitem"><a href="/">Home</a></li>
    <li class="nav-about" role="menuitem"><a href="/about/">About</a></li>
    <li class="nav-gsoc" role="menuitem"><a href="/gsoc-meta-k8s/">GSoC'19</a></li>
</ul>

        
    </div>
    <div class="site-nav-right">
        <div class="social-links">
            
                <a class="social-link" href="/feed.xml" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><circle cx="6.18" cy="17.82" r="2.18"/><path d="M4 4.44v2.83c7.03 0 12.73 5.7 12.73 12.73h2.83c0-8.59-6.97-15.56-15.56-15.56zm0 5.66v2.83c3.9 0 7.07 3.17 7.07 7.07h2.83c0-5.47-4.43-9.9-9.9-9.9z"/></svg>
</a>
            
            
                <a class="social-link social-link-gh" href="https://github.com/ajatprabha" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M12 0c-6.626 0-12 5.373-12 12 0 5.302 3.438 9.8 8.207 11.387.599.111.793-.261.793-.577v-2.234c-3.338.726-4.033-1.416-4.033-1.416-.546-1.387-1.333-1.756-1.333-1.756-1.089-.745.083-.729.083-.729 1.205.084 1.839 1.237 1.839 1.237 1.07 1.834 2.807 1.304 3.492.997.107-.775.418-1.305.762-1.604-2.665-.305-5.467-1.334-5.467-5.931 0-1.311.469-2.381 1.236-3.221-.124-.303-.535-1.524.117-3.176 0 0 1.008-.322 3.301 1.23.957-.266 1.983-.399 3.003-.404 1.02.005 2.047.138 3.006.404 2.291-1.552 3.297-1.23 3.297-1.23.653 1.653.242 2.874.118 3.176.77.84 1.235 1.911 1.235 3.221 0 4.609-2.807 5.624-5.479 5.921.43.372.823 1.102.823 2.222v3.293c0 .319.192.694.801.576 4.765-1.589 8.199-6.086 8.199-11.386 0-6.627-5.373-12-12-12z"/></svg></a>
            
            
                <a class="social-link social-link-li" href="https://www.linkedin.com/in/ajatprabha/" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24"><path d="M19 0h-14c-2.761 0-5 2.239-5 5v14c0 2.761 2.239 5 5 5h14c2.762 0 5-2.239 5-5v-14c0-2.761-2.238-5-5-5zm-11 19h-3v-11h3v11zm-1.5-12.268c-.966 0-1.75-.79-1.75-1.764s.784-1.764 1.75-1.764 1.75.79 1.75 1.764-.783 1.764-1.75 1.764zm13.5 12.268h-3v-5.604c0-3.368-4-3.113-4 0v5.604h-3v-11h3v1.765c1.396-2.586 7-2.777 7 2.476v6.759z"/></svg></a>
            
            
                <a class="social-link social-link-tw" href="https://twitter.com/ajatprabha" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>
</a>
            
            
                <a class="social-link social-link-fb" href="https://facebook.com/iAmAjat" target="_blank" rel="noopener"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>
</a>
            
        </div>
        
    </div>
</nav>

    </div>
</header>

<!-- Everything inside the #post tags pulls data from the post -->
<!-- #post -->

<main id="site-main" class="site-main outer" role="main">
    <div class="inner">

        <article class="post-full post tag-golang ">

            <header class="post-full-header">
                <section class="post-full-meta">
                    <time class="post-full-meta-date" datetime="24 May 2023">24 May 2023</time>
                    
                        <span class="date-divider">/</span>
                        
                            
                               <a href='/tag/golang/'>GOLANG</a>
                            
                        
                    
                </section>
                <h1 class="post-full-title">Introduction to xrun: A Flexible Package for Managing Component Lifecycles in Go</h1>
            </header>

            
            <figure class="post-full-image" style="background-image: url(/assets/images/gophers.jpg)">
            </figure>
            

            <section class="post-full-content">
                <div class="kg-card-markdown">
                    <p>Hello, Go community! Today, I am excited to announce a Golang package I have been working on named <code class="highlighter-rouge">xrun</code>. This package provides a streamlined way of running multiple components, specifically long-running components like an HTTP server or background worker. In this blog post, I will walk you through the basic functionality of <code class="highlighter-rouge">xrun</code> and how it can help you manage your long-running components more efficiently.</p>

<h1 id="introducing-xrun">Introducing xrun</h1>

<p>As the size and complexity of a Go service increase, managing the lifecycles of its various components becomes a daunting task. This post introduces <code class="highlighter-rouge">xrun</code>, a flexible and versatile Go package that simplifies this process, making it easier to reason about and manage your application’s components.</p>

<p>The package provides a <code class="highlighter-rouge">Manager</code> struct that handles starting and stopping components, coordinating their lifecycles in a way that makes your application more maintainable and less prone to bugs.</p>

<p>The <code class="highlighter-rouge">Manager</code> works by starting each component in its own goroutine and waiting for them to either finish or fail. It also ensures that the stop signals are propagated in reverse order of the components’ starting order, ensuring graceful shutdowns.</p>

<p><code class="highlighter-rouge">xrun</code> is available at <a href="https://github.com/gojekfarm/xrun">github.com/gojekfarm/xrun</a>, and you can read the full documentation on <a href="https://pkg.go.dev/github.com/gojekfarm/xrun">pkg.go.dev</a>.</p>

<h2 id="getting-started">Getting Started</h2>

<p>Let’s start by importing the <code class="highlighter-rouge">xrun</code> package:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="s">"github.com/gojekfarm/xrun"</span>
</code></pre></div></div>

<p>To illustrate how <code class="highlighter-rouge">xrun</code> works, let’s create an instance of an HTTP server:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="s">"net/http"</span>

<span class="n">server</span> <span class="o">:=</span> <span class="n">http</span><span class="o">.</span><span class="n">Server</span><span class="p">{</span><span class="n">Addr</span><span class="o">:</span> <span class="s">":9090"</span><span class="p">}</span>
</code></pre></div></div>

<p>Next, create a new manager with <code class="highlighter-rouge">xrun.NewManager()</code>. Then use <code class="highlighter-rouge">m.Add()</code> to add the HTTP server to the manager:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">(</span>
	<span class="s">"github.com/gojekfarm/xrun"</span>
	<span class="s">"github.com/gojekfarm/xrun/component"</span>
<span class="p">)</span>

<span class="n">m</span> <span class="o">:=</span> <span class="n">xrun</span><span class="o">.</span><span class="n">NewManager</span><span class="p">()</span>
<span class="n">_</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">component</span><span class="o">.</span><span class="n">HTTPServer</span><span class="p">(</span><span class="n">component</span><span class="o">.</span><span class="n">HTTPServerOptions</span><span class="p">{</span><span class="n">Server</span><span class="o">:</span> <span class="o">&amp;</span><span class="n">server</span><span class="p">}))</span>
</code></pre></div></div>

<p>Finally, run the manager using <code class="highlighter-rouge">m.Run(ctx)</code>. If there is an error, the process will exit:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">import</span> <span class="p">(</span>
	<span class="s">"os"</span>
	<span class="s">"os/signal"</span>
<span class="p">)</span>

<span class="n">ctx</span><span class="p">,</span> <span class="n">stop</span> <span class="o">:=</span> <span class="n">signal</span><span class="o">.</span><span class="n">NotifyContext</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Background</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">Interrupt</span><span class="p">)</span>
<span class="k">defer</span> <span class="n">stop</span><span class="p">()</span>

<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">m</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
	<span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="features-of-xrun">Features of <code class="highlighter-rouge">xrun</code></h2>

<p>Now, let’s dive into some features of <code class="highlighter-rouge">xrun</code>.</p>

<h5 id="component">Component</h5>

<p>The <code class="highlighter-rouge">Component</code> interface is the foundation of <code class="highlighter-rouge">xrun</code>. It allows you to start a component that will run until the context is closed or an error occurs:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Component</span> <span class="k">interface</span> <span class="p">{</span>
    <span class="n">Run</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="kt">error</span>
<span class="p">}</span>
</code></pre></div></div>

<hr />

<h5 id="componentfunc">ComponentFunc</h5>

<p><code class="highlighter-rouge">ComponentFunc</code> is a helper that allows you to implement <code class="highlighter-rouge">Component</code> inline. It’s perfect for writing custom components on the fly:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">ComponentFunc</span> <span class="k">func</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="kt">error</span>
</code></pre></div></div>

<hr />

<h5 id="manager">Manager</h5>

<p>The <code class="highlighter-rouge">Manager</code> type helps you to run multiple components and waits for them to complete. You can add components with the <code class="highlighter-rouge">Add()</code> method and run them with the <code class="highlighter-rouge">Run()</code> method:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">Manager</span> <span class="k">struct</span> <span class="p">{</span>
    <span class="c">// ...</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span><span class="n">Manager</span><span class="p">)</span> <span class="n">Add</span><span class="p">(</span><span class="n">c</span> <span class="n">Component</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
<span class="k">func</span> <span class="p">(</span><span class="n">m</span> <span class="o">*</span><span class="n">Manager</span><span class="p">)</span> <span class="n">Run</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="p">(</span><span class="n">err</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
</code></pre></div></div>

<blockquote>
  <p>Note: Since <code class="highlighter-rouge">Manager</code> has a <code class="highlighter-rouge">Run(context.Context) error</code> method, it is a <code class="highlighter-rouge">Component</code> in itself, and hence, it is possible to nest multiple <code class="highlighter-rouge">Manager(s)</code>.</p>
</blockquote>

<h2 id="creating-and-using-components">Creating and Using Components</h2>

<p>A component in <code class="highlighter-rouge">xrun</code> is anything that implements the <code class="highlighter-rouge">Component</code> interface. This interface only requires a single method: <code class="highlighter-rouge">Run(context.Context) error</code>.</p>

<p>Here’s an example of a basic component, a <code class="highlighter-rouge">ScheduledTask</code>:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">type</span> <span class="n">ScheduledTask</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Ticker</span> <span class="o">*</span><span class="n">time</span><span class="o">.</span><span class="n">Ticker</span>
	<span class="n">Task</span>   <span class="k">func</span><span class="p">()</span>
<span class="p">}</span>

<span class="k">func</span> <span class="p">(</span><span class="n">s</span> <span class="o">*</span><span class="n">ScheduledTask</span><span class="p">)</span> <span class="n">Run</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
	<span class="k">for</span> <span class="p">{</span>
		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="n">s</span><span class="o">.</span><span class="n">Ticker</span><span class="o">.</span><span class="n">C</span><span class="o">:</span>
			<span class="n">s</span><span class="o">.</span><span class="n">Task</span><span class="p">()</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="n">ctx</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span><span class="o">:</span>
			<span class="k">return</span> <span class="no">nil</span>
		<span class="p">}</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In the main function, you create a manager and add your components to it:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">m</span> <span class="o">:=</span> <span class="n">xrun</span><span class="o">.</span><span class="n">NewManager</span><span class="p">()</span>

<span class="n">tick</span> <span class="o">:=</span> <span class="n">time</span><span class="o">.</span><span class="n">NewTicker</span><span class="p">(</span><span class="m">1</span> <span class="o">*</span> <span class="n">time</span><span class="o">.</span><span class="n">Second</span><span class="p">)</span>
<span class="n">task</span> <span class="o">:=</span> <span class="k">func</span><span class="p">()</span> <span class="p">{</span> <span class="n">fmt</span><span class="o">.</span><span class="n">Println</span><span class="p">(</span><span class="s">"Task executed"</span><span class="p">)</span> <span class="p">}</span>
<span class="n">s</span> <span class="o">:=</span> <span class="o">&amp;</span><span class="n">ScheduledTask</span><span class="p">{</span><span class="n">Ticker</span><span class="o">:</span> <span class="n">tick</span><span class="p">,</span> <span class="n">Task</span><span class="o">:</span> <span class="n">task</span><span class="p">}</span>

<span class="n">_</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

<span class="n">ctx</span><span class="p">,</span> <span class="n">stop</span> <span class="o">:=</span> <span class="n">signal</span><span class="o">.</span><span class="n">NotifyContext</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Background</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">Interrupt</span><span class="p">)</span>
<span class="k">defer</span> <span class="n">stop</span><span class="p">()</span>

<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">m</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
    <span class="n">log</span><span class="o">.</span><span class="n">Fatal</span><span class="p">(</span><span class="n">err</span><span class="p">)</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="extending-xrun-custom-component-examples">Extending xrun: Custom Component Examples</h2>

<p>While <code class="highlighter-rouge">xrun</code> provides some built-in components, you can create your own to suit your specific needs.</p>

<h3 id="http-server">HTTP Server</h3>

<p>The <code class="highlighter-rouge">xrun</code> package includes an HTTP server component out of the box. It is available in the <code class="highlighter-rouge">xrun/component</code> subpackage.</p>

<h3 id="grpc-server-experimental">gRPC Server (Experimental)</h3>

<p>For more advanced use cases, you can create custom components like a gRPC server. An experimental gRPC server component is available in the <code class="highlighter-rouge">component/x/grpc</code> subpackage.</p>

<p>Here’s an example of how you might create such a component:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">grpc</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"context"</span>
	<span class="s">"net"</span>

	<span class="s">"github.com/gojekfarm/xrun"</span>
	<span class="s">"google.golang.org/grpc"</span>
<span class="p">)</span>

<span class="c">// Options holds options for Server</span>
<span class="k">type</span> <span class="n">Options</span> <span class="k">struct</span> <span class="p">{</span>
	<span class="n">Server</span>      <span class="o">*</span><span class="n">grpc</span><span class="o">.</span><span class="n">Server</span>
	<span class="n">NewListener</span> <span class="k">func</span><span class="p">()</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">Listener</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span>
<span class="p">}</span>

<span class="c">// Server is a helper which returns a xrun.ComponentFunc to start a grpc.Server</span>
<span class="k">func</span> <span class="n">Server</span><span class="p">(</span><span class="n">opts</span> <span class="n">Options</span><span class="p">)</span> <span class="n">xrun</span><span class="o">.</span><span class="n">ComponentFunc</span> <span class="p">{</span>
	<span class="n">srv</span> <span class="o">:=</span> <span class="n">opts</span><span class="o">.</span><span class="n">Server</span>
	<span class="n">nl</span> <span class="o">:=</span> <span class="n">opts</span><span class="o">.</span><span class="n">NewListener</span>

	<span class="k">return</span> <span class="k">func</span><span class="p">(</span><span class="n">ctx</span> <span class="n">context</span><span class="o">.</span><span class="n">Context</span><span class="p">)</span> <span class="kt">error</span> <span class="p">{</span>
		<span class="n">l</span><span class="p">,</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">nl</span><span class="p">()</span>
		<span class="k">if</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
			<span class="k">return</span> <span class="n">err</span>
		<span class="p">}</span>

		<span class="n">errCh</span> <span class="o">:=</span> <span class="nb">make</span><span class="p">(</span><span class="k">chan</span> <span class="kt">error</span><span class="p">,</span> <span class="m">1</span><span class="p">)</span>

		<span class="k">go</span> <span class="k">func</span><span class="p">(</span><span class="n">errCh</span> <span class="k">chan</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
			<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">srv</span><span class="o">.</span><span class="n">Serve</span><span class="p">(</span><span class="n">l</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="o">&amp;&amp;</span> <span class="n">err</span> <span class="o">!=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">ErrServerStopped</span> <span class="p">{</span>
				<span class="n">errCh</span> <span class="o">&lt;-</span> <span class="n">err</span>
			<span class="p">}</span>
		<span class="p">}(</span><span class="n">errCh</span><span class="p">)</span>

		<span class="k">select</span> <span class="p">{</span>
		<span class="k">case</span> <span class="o">&lt;-</span><span class="n">ctx</span><span class="o">.</span><span class="n">Done</span><span class="p">()</span><span class="o">:</span>
		<span class="k">case</span> <span class="n">err</span> <span class="o">:=</span> <span class="o">&lt;-</span><span class="n">errCh</span><span class="o">:</span>
			<span class="k">return</span> <span class="n">err</span>
		<span class="p">}</span>
		<span class="n">srv</span><span class="o">.</span><span class="n">GracefulStop</span><span class="p">()</span>

		<span class="k">return</span> <span class="no">nil</span>
	<span class="p">}</span>
<span class="p">}</span>

<span class="k">func</span> <span class="n">NewListener</span><span class="p">(</span><span class="n">address</span> <span class="kt">string</span><span class="p">)</span> <span class="k">func</span><span class="p">()</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">Listener</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="k">func</span><span class="p">()</span> <span class="p">(</span><span class="n">net</span><span class="o">.</span><span class="n">Listener</span><span class="p">,</span> <span class="kt">error</span><span class="p">)</span> <span class="p">{</span>
		<span class="k">return</span> <span class="n">net</span><span class="o">.</span><span class="n">Listen</span><span class="p">(</span><span class="s">"tcp"</span><span class="p">,</span> <span class="n">address</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<p>In this example, we define a new <code class="highlighter-rouge">Options</code> struct that includes our gRPC server instance and a <code class="highlighter-rouge">NewListener</code> function. This function creates a network listener on the given address.</p>

<p>Next, we define a <code class="highlighter-rouge">Server</code> function that takes an <code class="highlighter-rouge">Options</code> instance and returns a <code class="highlighter-rouge">xrun.ComponentFunc</code>. This <code class="highlighter-rouge">ComponentFunc</code> starts the gRPC server and manages its lifecycle. It starts the server in a goroutine and then enters a select block. If the context is done, the gRPC server is stopped gracefully. If an error occurs while serving, it’s returned.</p>

<p>The <code class="highlighter-rouge">NewListener</code> function is a helper that generates a function for creating a network listener.</p>

<p>Here’s how to use it:</p>

<div class="language-go highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">package</span> <span class="n">main</span>

<span class="k">import</span> <span class="p">(</span>
	<span class="s">"context"</span>
	<span class="s">"net"</span>
	<span class="s">"os"</span>
	<span class="s">"os/signal"</span>

	<span class="n">xgrpc</span> <span class="s">"yourgrpcpackage"</span>
	<span class="s">"github.com/gojekfarm/xrun"</span>
	<span class="s">"google.golang.org/grpc"</span>
<span class="p">)</span>

<span class="k">func</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
	<span class="n">s</span> <span class="o">:=</span> <span class="n">grpc</span><span class="o">.</span><span class="n">NewServer</span><span class="p">()</span>
	<span class="n">m</span> <span class="o">:=</span> <span class="n">xrun</span><span class="o">.</span><span class="n">NewManager</span><span class="p">()</span>

	<span class="n">grpcComponent</span> <span class="o">:=</span> <span class="n">xgrpc</span><span class="o">.</span><span class="n">Server</span><span class="p">(</span><span class="n">xgrpc</span><span class="o">.</span><span class="n">Options</span><span class="p">{</span>
		<span class="n">Server</span><span class="o">:</span>      <span class="n">s</span><span class="p">,</span>
		<span class="n">NewListener</span><span class="o">:</span> <span class="n">xgrpc</span><span class="o">.</span><span class="n">NewListener</span><span class="p">(</span><span class="s">":8500"</span><span class="p">),</span>
	<span class="p">})</span>

	<span class="n">_</span> <span class="o">=</span> <span class="n">m</span><span class="o">.</span><span class="n">Add</span><span class="p">(</span><span class="n">grpcComponent</span><span class="p">)</span>

	<span class="n">ctx</span><span class="p">,</span> <span class="n">stop</span> <span class="o">:=</span> <span class="n">signal</span><span class="o">.</span><span class="n">NotifyContext</span><span class="p">(</span><span class="n">context</span><span class="o">.</span><span class="n">Background</span><span class="p">(),</span> <span class="n">os</span><span class="o">.</span><span class="n">Interrupt</span><span class="p">)</span>
	<span class="k">defer</span> <span class="n">stop</span><span class="p">()</span>

	<span class="k">if</span> <span class="n">err</span> <span class="o">:=</span> <span class="n">m</span><span class="o">.</span><span class="n">Run</span><span class="p">(</span><span class="n">ctx</span><span class="p">);</span> <span class="n">err</span> <span class="o">!=</span> <span class="no">nil</span> <span class="p">{</span>
		<span class="n">os</span><span class="o">.</span><span class="n">Exit</span><span class="p">(</span><span class="m">1</span><span class="p">)</span>
	<span class="p">}</span>
<span class="p">}</span>
</code></pre></div></div>

<h2 id="conclusion">Conclusion</h2>

<p>The <code class="highlighter-rouge">xrun</code> package makes it easier to manage component lifecycles in your Go applications. By allowing you to define and control how each component starts and stops, you can make your application more maintainable and robust.</p>

<p>Finally, I’d like to give credits to the authors at the Kubernetes community. The manager source of <code class="highlighter-rouge">xrun</code> has been heavily influenced by the <a href="https://github.com/kubernetes-sigs/controller-runtime/tree/a1e2ea2/pkg/manager">sigs.k8s.io/controller-runtime</a> package.</p>

<p>Thanks for reading, and I hope you find <code class="highlighter-rouge">xrun</code> as useful as I do!</p>

<hr />

<p>Contributions, questions, and feedback are most welcome on the xrun <a href="https://github.com/gojekfarm/xrun">GitHub</a> repository. Happy coding, Gophers!</p>

                </div>
            </section>

            <!-- Email subscribe form at the bottom of the page -->
            

            <footer class="post-full-footer">
                <!-- Everything inside the #author tags pulls data from the author -->
                <!-- #author-->
                
                    
                        <section class="author-card">
                            
                                <img class="author-profile-image" src="/assets/images/ajat.jpg" alt="ajatprabha" />
                            
                            <section class="author-card-content">
                                <h4 class="author-card-name"><a href="/author/ajatprabha">Ajat Prabha</a></h4>
                                
                                    <p>Code | Music | Travel</p>
                                
                            </section>
                        </section>
                        <div class="post-full-footer-right">
                            <a class="author-card-button" href="/author/ajatprabha">Read More</a>
                        </div>
                    
                
                <!-- /author  -->
            </footer>

            <!-- If you use Disqus comments, just uncomment this block.
            The only thing you need to change is "test-apkdzgmqhj" - which
            should be replaced with your own Disqus site-id. -->
            
                <section class="post-full-comments">
                    <div id="disqus_thread"></div>
                    <script>
                        var disqus_config = function () {
                            this.page.url = 'https://ajatprabha.in/';
                            this.page.identifier = 'Ajat Prabha';
                        };
                        (function() {
                            var d = document, s = d.createElement('script');
                            s.src = 'https://ajat-prabha.disqus.com/embed.js';
                            s.setAttribute('data-timestamp', +new Date());
                            (d.head || d.body).appendChild(s);
                        })();
                    </script>
                </section>
            

        </article>

    </div>
</main>

<!-- Links to Previous/Next posts -->
<aside class="read-next outer">
    <div class="inner">
        <div class="read-next-feed">
            
                
                
                
                
                    <article class="read-next-card"
                        
                            style="background-image: url(/assets/images/blog-cover.jpg)"
                        
                    >
                        <header class="read-next-card-header">
                            <small class="read-next-card-header-sitetitle">&mdash; Ajat Prabha &mdash;</small>
                            
                                <h3 class="read-next-card-header-title"><a href="/tag/golang/">Golang</a></h3>
                            
                        </header>
                        <div class="read-next-divider"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 14.5s2 3 5 3 5.5-2.463 5.5-5.5S21 6.5 18 6.5c-5 0-7 11-12 11C2.962 17.5.5 15.037.5 12S3 6.5 6 6.5s4.5 3.5 4.5 3.5"/></svg>
</div>
                        <div class="read-next-card-content">
                            <ul>
                                
                                
                                  
                                    
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/2020/06/24/k8s-operator-with-api-server-for-gui">Writing Kubernetes Operator with an API Server for Custom GUI</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                    
                                        
                                        
                                            <li><a href="/2018/06/03/second-week-at-gojek">Week 2 - Exploring Golang and the trip to Coorg</a></li>
                                        
                                    
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                                  
                                
                            </ul>
                        </div>
                        <footer class="read-next-card-footer">
                            <a href="/tag/golang/">
                                
                                    See all 2 posts  →
                                
                            </a>
                        </footer>
                    </article>
                
            

            <!-- If there's a next post, display it using the same markup included from - partials/post-card.hbs -->
            

            <!-- If there's a previous post, display it using the same markup included from - partials/post-card.hbs -->
            
                
    <article class="post-card post-template">
        
            <a class="post-card-image-link" href="/2020/10/06/diy-sound-system-minimalistic">
                <div class="post-card-image" style="background-image: url(/assets/images/IMG_20201007_235240.jpg)"></div>
            </a>
        
        <div class="post-card-content">
            <a class="post-card-content-link" href="/2020/10/06/diy-sound-system-minimalistic">
                <header class="post-card-header">
                    
                        
                            
                               <span class="post-card-tags">Diy</span>
                            
                        
                            
                                <span class="post-card-tags">Sound</span>
                            
                        
                    

                    <h2 class="post-card-title">Making a DIY Sound System that looks minimalistic</h2>
                </header>
                <section class="post-card-excerpt">
                    <p>I’m a huge music enthusiast and I listen to music almost half the day while working. Good quality speakers are a must for me. Recently I was changing the furniture in my house</p>
                </section>
            </a>
            <footer class="post-card-meta">
                
                    
                        
                        <img class="author-profile-image" src="/assets/images/ajat.jpg" alt="Ajat Prabha" />
                        
                        <span class="post-card-author">
                            <a href="/author/ajatprabha/">Ajat Prabha</a>
                        </span>
                    
                
            </footer>
        </div>
    </article>

            

        </div>
    </div>
</aside>

<!-- Floating header which appears on-scroll, included from includes/floating-header.hbs -->
<div class="floating-header">
    <div class="floating-header-logo">
        <a href="https://ajatprabha.in/">
            
                <img src="/assets/images/favicon.png" alt="Ajat Prabha icon" />
            
            <span>Ajat Prabha</span>
        </a>
    </div>
    <span class="floating-header-divider">&mdash;</span>
    <div class="floating-header-title">Introduction to xrun: A Flexible Package for Managing Component Lifecycles in Go</div>
    <div class="floating-header-share">
        <div class="floating-header-share-label">Share this <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
    <path d="M7.5 15.5V4a1.5 1.5 0 1 1 3 0v4.5h2a1 1 0 0 1 1 1h2a1 1 0 0 1 1 1H18a1.5 1.5 0 0 1 1.5 1.5v3.099c0 .929-.13 1.854-.385 2.748L17.5 23.5h-9c-1.5-2-5.417-8.673-5.417-8.673a1.2 1.2 0 0 1 1.76-1.605L7.5 15.5zm6-6v2m-3-3.5v3.5m6-1v2"/>
</svg>
</div>
        <a class="floating-header-share-tw" href="https://twitter.com/share?text=Introduction+to+xrun%3A+A+Flexible+Package+for+Managing+Component+Lifecycles+in+Go&amp;url=https://ajatprabha.in/2023/05/24/intro-xrun-package-managing-component-lifecycle-go"
            onclick="window.open(this.href, 'share-twitter', 'width=550,height=235');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M30.063 7.313c-.813 1.125-1.75 2.125-2.875 2.938v.75c0 1.563-.188 3.125-.688 4.625a15.088 15.088 0 0 1-2.063 4.438c-.875 1.438-2 2.688-3.25 3.813a15.015 15.015 0 0 1-4.625 2.563c-1.813.688-3.75 1-5.75 1-3.25 0-6.188-.875-8.875-2.625.438.063.875.125 1.375.125 2.688 0 5.063-.875 7.188-2.5-1.25 0-2.375-.375-3.375-1.125s-1.688-1.688-2.063-2.875c.438.063.813.125 1.125.125.5 0 1-.063 1.5-.25-1.313-.25-2.438-.938-3.313-1.938a5.673 5.673 0 0 1-1.313-3.688v-.063c.813.438 1.688.688 2.625.688a5.228 5.228 0 0 1-1.875-2c-.5-.875-.688-1.813-.688-2.75 0-1.063.25-2.063.75-2.938 1.438 1.75 3.188 3.188 5.25 4.25s4.313 1.688 6.688 1.813a5.579 5.579 0 0 1 1.5-5.438c1.125-1.125 2.5-1.688 4.125-1.688s3.063.625 4.188 1.813a11.48 11.48 0 0 0 3.688-1.375c-.438 1.375-1.313 2.438-2.563 3.188 1.125-.125 2.188-.438 3.313-.875z"/></svg>

        </a>
        <a class="floating-header-share-fb" href="https://www.facebook.com/sharer/sharer.php?u=https://ajatprabha.in/2023/05/24/intro-xrun-package-managing-component-lifecycle-go"
            onclick="window.open(this.href, 'share-facebook','width=580,height=296');return false;">
            <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 32 32"><path d="M19 6h5V0h-5c-3.86 0-7 3.14-7 7v3H8v6h4v16h6V16h5l1-6h-6V7c0-.542.458-1 1-1z"/></svg>

        </a>
    </div>
    <progress class="progress" value="0">
        <div class="progress-container">
            <span class="progress-bar"></span>
        </div>
    </progress>
</div>


<!-- /post -->

<!-- The #contentFor helper here will send everything inside it up to the matching #block helper found in default.hbs -->


        <!-- Previous/next page links - displayed on every page -->
        

        <!-- The footer at the very bottom of the screen -->
        <footer class="site-footer outer">
            <div class="site-footer-content inner">
                <section class="copyright"><a href="https://ajatprabha.in/">Ajat Prabha</a> &copy; 2023</section>
                <section class="poweredby">Proudly published with <a href="https://jekyllrb.com/">Jekyll</a> &
                    <a href="https://pages.github.com/" target="_blank" rel="noopener">GitHub Pages</a> using
                    <a href="https://github.com/jekyller/jasper2" target="_blank" rel="noopener">Jasper2</a></section>
                <nav class="site-footer-nav">
                    <a href="/">Latest Posts</a>
                    <a href="https://github.com/ajatprabha" target="_blank" rel="noopener">Github</a>
                    <a href="https://www.linkedin.com/in/ajatprabha/" target="_blank" rel="noopener">LinkedIn</a>
                    <a href="https://twitter.com/ajatprabha" target="_blank" rel="noopener">Twitter</a>
                    <a href="https://facebook.com/iAmAjat" target="_blank" rel="noopener">Facebook</a>
                </nav>
            </div>
        </footer>

    </div>

    <!-- The big email subscribe modal content -->
    

    <!-- highlight.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.10.0/components/prism-abap.min.js"></script>
    <script>$(document).ready(function() {
      $('pre code').each(function(i, block) {
        hljs.highlightBlock(block);
      });
    });</script>

    <!-- jQuery + Fitvids, which makes all video embeds responsive -->
    <script
        src="https://code.jquery.com/jquery-3.2.1.min.js"
        integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
        crossorigin="anonymous">
    </script>
    <script type="text/javascript" src="/assets/js/jquery.fitvids.js"></script>
    <script type="text/javascript" src="https://demo.ghost.io/assets/js/jquery.fitvids.js?v=724281a32e"></script>


    <!-- Paginator increased to "infinit" in _config.yml -->
    <!-- if paginator.posts  -->
    <!-- <script>
        var maxPages = parseInt('');
    </script>
    <script src="/assets/js/infinitescroll.js"></script> -->
    <!-- /endif -->

    


    <!-- Add Google Analytics  -->
    <!-- Google Analytics Tracking code -->
 <script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
  (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
  m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

  ga('create', 'UA-111176207-1', 'auto');
  ga('send', 'pageview');

 </script>


    <!-- The #block helper will pull in data from the #contentFor other template files. In this case, there's some JavaScript which we only want to use in post.hbs, but it needs to be included down here, after jQuery has already loaded. -->
    
        <script>

// NOTE: Scroll performance is poor in Safari
// - this appears to be due to the events firing much more slowly in Safari.
//   Dropping the scroll event and using only a raf loop results in smoother
//   scrolling but continuous processing even when not scrolling
$(document).ready(function () {
    // Start fitVids
    var $postContent = $(".post-full-content");
    $postContent.fitVids();
    // End fitVids

    var progressBar = document.querySelector('progress');
    var header = document.querySelector('.floating-header');
    var title = document.querySelector('.post-full-title');

    var lastScrollY = window.scrollY;
    var lastWindowHeight = window.innerHeight;
    var lastDocumentHeight = $(document).height();
    var ticking = false;

    function onScroll() {
        lastScrollY = window.scrollY;
        requestTick();
    }

    function onResize() {
        lastWindowHeight = window.innerHeight;
        lastDocumentHeight = $(document).height();
        requestTick();
    }

    function requestTick() {
        if (!ticking) {
            requestAnimationFrame(update);
        }
        ticking = true;
    }

    function update() {
        var trigger = title.getBoundingClientRect().top + window.scrollY;
        var triggerOffset = title.offsetHeight + 35;
        var progressMax = lastDocumentHeight - lastWindowHeight;

        // show/hide floating header
        if (lastScrollY >= trigger + triggerOffset) {
            header.classList.add('floating-active');
        } else {
            header.classList.remove('floating-active');
        }

        progressBar.setAttribute('max', progressMax);
        progressBar.setAttribute('value', lastScrollY);

        ticking = false;
    }

    window.addEventListener('scroll', onScroll, {passive: true});
    window.addEventListener('resize', onResize, false);

    update();
});
</script>

    

    <!-- Ghost outputs important scripts and data with this tag - it should always be the very last thing before the closing body tag -->
    <!-- ghost_foot -->

</body>
</html>
